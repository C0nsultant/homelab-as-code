apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: nextcloud
    namespace: default
spec:
    interval: 1m
    chart:
        spec:
            chart: nextcloud
            version: 6.5.1
            sourceRef:
                kind: HelmRepository
                name: nextcloud
                namespace: flux-system
    values:
        image:
            flavor: fpm-alpine
        # https://github.com/nextcloud/helm/issues/10
        # https://github.com/nextcloud/helm/issues/399
        startupProbe:
            enabled: true
            initialDelaySeconds: 120
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 50
            successThreshold: 1
        ingress:
            enabled: true
            className: nginx
            annotations:
                cert-manager.io/cluster-issuer: letsencrypt
                nginx.ingress.kubernetes.io/affinity: cookie
                nginx.ingress.kubernetes.io/cors-allow-headers: X-Forwarded-For
                nginx.ingress.kubernetes.io/enable-cors: "true"
                nginx.ingress.kubernetes.io/proxy-body-size: 4G
                nginx.ingress.kubernetes.io/server-snippet: |-
                    server_tokens off;
                    proxy_hide_header X-Powered-By;
                    rewrite ^/.well-known/webfinger /index.php/.well-known/webfinger last;
                    rewrite ^/.well-known/nodeinfo /index.php/.well-known/nodeinfo last;
                    rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
                    rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json;
                    location = /.well-known/carddav {
                        return 301 $scheme://$host/remote.php/dav;
                    }
                    location = /.well-known/caldav {
                        return 301 $scheme://$host/remote.php/dav;
                    }
                    location = /robots.txt {
                        allow all;
                        log_not_found off;
                        access_log off;
                    }
                    location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
                        deny all;
                    }
                    location ~ ^/(?:autotest|occ|issue|indie|db_|console) {
                        deny all;
                    }
            tls:
                - secretName: nextcloud-tls
                  hosts:
                    - ENC[AES256_GCM,data:EcoaSnq6hfb3UMCIyHaCjxcbmQfqjg==,iv:ubOjtzT8bVjh4EBA+N3DLcso9OUGrZzRz7Ety0X8qY0=,tag:pYBsyPXhcbcSPZZeafGRWw==,type:str]
        phpClientHttpsFix:
            enabled: true
        nextcloud:
            host: ENC[AES256_GCM,data:pTF2NVV5U6CTc/aD2xVHCikN1wJOzg==,iv:3iTgBpL8vhBkQI4XHt/Cw9Uv9LGEyh98rtfLKXESEmU=,tag:b0OcwjVxm7ErgkU5R20SyQ==,type:str]
            trustedDomains:
                - ENC[AES256_GCM,data:GlJ5rqIyk94T,iv:uqjhLO7okuRR/fQi6ZVxZN1Wzqb6RV6PV2qZlc6BN4k=,tag:ZnsM5znBfufzVuiPjx7bZQ==,type:str]
                - ENC[AES256_GCM,data:N0MnHzXhaGxkOfwdXNcs2khPqOhemA==,iv:nOTUDiyS/rcTFTBwRax0g4aR92glk89joNS1tIDERV0=,tag:OuQoxJSS6wqIx2b/ufIDRA==,type:str]
            defaultConfigs:
                imaginary.config.php: true
            configs:
                proxy.config.php: |-
                    <?php
                    $CONFIG = array (
                      'trusted_proxies' => array(
                        0 => '127.0.0.1',
                        1 => '172.16.0.0/24',
                        2 => '172.32.0.0/16',
                        3 => 'fd08:172:16::/112',
                        4 => 'fd08:172:32::/56',
                      ),
                      'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
                    );
            mail:
                enabled: true
                fromAddress: ENC[AES256_GCM,data:MZ7RaotCl/Js,iv:bL/mqSlCUcO194azD8uHxEV2sWVu+qPRmfqyuEy5//k=,tag:J1k1DeDxS8DOMn9W/lXIHQ==,type:str]
                domain: ENC[AES256_GCM,data:QiBKnvzFv6ic1asi,iv:20Xl3VJcUygCMpnv3Z1Vs2BoYwmO3pSaS9wzFRYmbtQ=,tag:ubieB2T83kviJk4pmAhzIQ==,type:str]
                smtp:
                    host: ENC[AES256_GCM,data:4A5m/lJRe/UcIXPbIShkShQ=,iv:3h3ZUjamLU2Rqc21sNyP3S9xjKfahicVPYiFN51L5I0=,tag:yfvuS7jsqJUnvSNd5+8zqQ==,type:str]
                    port: ENC[AES256_GCM,data:qW60,iv:9SD6WYzI3QYGZBSjBIQuxNz0sWHQ6em2JscHGMUsM1E=,tag:dKWPd9atI0cFewUI/m3E7g==,type:int]
                    secure: ENC[AES256_GCM,data:W7Gv,iv:cScDbZEClW5pIOGEGJ7yHP5rhhiCd9FIA3r792J2GiM=,tag:+2TCgV6qPhDIWGSx0S0ghw==,type:str]
                    authtype: ENC[AES256_GCM,data:AhEW9Bc=,iv:fciZZ6ZOAAaF+o6lX9scDZHnDKtQa6r7Q4wrhjrX7iI=,tag:vxb20SPTXTbGBiD879S4KQ==,type:str]
                    name: ENC[AES256_GCM,data:W/1DtrAM,iv:0irguuPYicssuLq45tAHpCfnW6Qhl3X4XIoiohh0vDQ=,tag:OqKzda6wHyFeSb0QeTbarQ==,type:str]
                    password: ENC[AES256_GCM,data:U51GgVgQdr5tGNjxMVGYMPM/wCaL0HOiWhhppOvcRZ1ldfyC2ORUFMMO7uEQ5/wE2kJNoyNTm78etQ5oOlSef9Slw9X6,iv:c/6EINW7fMKTkSa+ATul2lx4KbxFd07mX19eg4cHblg=,tag:iX6JsaSuc9SBsx0zx25edQ==,type:str]
            extraVolumes:
                - name: paperless-consume
                  nfs:
                    server: 192.168.1.2
                    path: /mnt/tank/Dokumente/Paperless/consume
            extraVolumeMounts:
                - name: paperless-consume
                  mountPath: ENC[AES256_GCM,data:QMB0XQAnQVgk1yp9kdLF4sykl6xoqRfLBtEMkj2l1+wz53FKX1HajVqz/Q4lKwsb+A==,iv:OHT6prlirfim5ue2ytN6GQt6oQDeQi+OK9Gw9fVGf2c=,tag:N0Daa3hwa1gogRZMsJPziQ==,type:str]
        imaginary:
            enabled: true
        nginx:
            enabled: true
            ipFamilies:
                - IPv4
                - IPv6
        redis:
            enabled: true
            auth:
                enabled: true
                password: ENC[AES256_GCM,data:NBIcYv29jaoEFZkzl4RBbt60QHhKbi+SpfZtIWdRtQg=,iv:hPjTNoEpvlbiJMcULgx7Y9WEOAVb8T76zz3QfQ+iTyU=,tag:IViHI4kzg5OigJdE6SFaTQ==,type:str]
            global:
                storageClass: cluster-scratch
            master:
                persistence:
                    size: 2Gi
            architecture: standalone
        cronjob:
            enabled: true
        internalDatabase:
            enabled: false
        externalDatabase:
            enabled: true
            type: postgresql
        postgresql:
            enabled: true
            global:
                postgresql:
                    auth:
                        password: ENC[AES256_GCM,data:xGd7boEEgjTI4fBIbWyZv1MBwAU30QH2eHpYDitsBn8=,iv:kIqf1yBkC61KXCeL8Z/zSNgZOW38VJvuaabe0EQ/PcA=,tag:9aw0hus8Yad/lQKlai082w==,type:str]
            primary:
                persistence:
                    enabled: true
                    storageClass: cluster-replicated
                    size: 2Gi
        persistence:
            enabled: true
            storageClass: cluster-replicated
            size: 2Gi
            nextcloudData:
                enabled: true
                storageClass: cluster-replicated
                size: 100Gi
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age168avplsha0pc878zkkgnx2n7zku0grgmwal2grmxjxnx579j9ffq0a0yfp
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSArcExxaDZDbTYxOUgyVDQ1
            WDRJeDY5b3NZTWxBbXFldG1KM01kdUxIaHg0Ck15K2RwZUI5TlRlOEZQczg5YlRT
            eVJsUzZiNU9IN1loMDkzWE9IN1NhMEkKLS0tICtkcmg0NFZWL0tWZ2RnRkJPcXR4
            V0ovUU5xS09Mc1E4Yzgxc0JTL3VJT1kKl/TlkJv6pJRGRH5PEanMewsjRkCRsi2q
            J/J4n0OG31s/FE5qc0/C5qV7mdKdPsZ0FhqXc5W723bmy2L/x0USAw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-27T21:57:24Z"
    mac: ENC[AES256_GCM,data:MBo8pWkR55k0jPGSwvVOumJRjO0eo+Xvj9t58aH4aUXae6QLN3DvvUZfAJduY8alC1pwCahtEMYmlWMDhqPlh7282MREwUrT8u+jeeUgDZfr4bRUtkbZD4RRIlEQPdMg+CSRvVtwUpt1kyvqsqFIggDWrDI55gtu4IYHSmw1qnM=,iv:KWt2MmeTsB5KLHdm5nNCTdcQKGjOj81rwtIYhp4gVCI=,tag:6C0gX1jfgyETd7hvn/nOFA==,type:str]
    pgp: []
    encrypted_regex: ^.*(host|hosts|trustedDomains|fromAddress|domain|smtp|password|mountPath)$
    version: 3.9.2
